# shellcheck shell=sh disable=SC2039

# author:       Li Junhao           edwin.jh.lee@gmail.com    edwinjhlee.github.io
# maintainer:   Li Tinghui

# if ! declare -f xrc 1>/dev/null;  then
#     : introduce the boot file
# fi

xrc param/v0

# Reference
# https://ding-doc.qywx.com/document#/isv-dev-guide/message-types-and-data-format#topic-2618201

qywx_bot(){
    local op
    if [ $# -eq 0 ]; then
        op=help
    else
        op="${1}"
        shift
    fi
    case "$op" in
        make)               qywx_bot_make       "$@" ;;
        endpoint)           qywx_bot_endpoint   "$@" ;;
        config)             qywx_bot_config     "$@" ;;
        send|sendmsg)       qywx_bot_send       "$@" ;;
    esac
}

qywx_bot_send(){
    local op
    if [ $# -eq 0 ]; then
        op=help
    else
        op="${1}"
        shift
    fi
    case "$op" in
        markdown)           qywx_bot_send_markdown_msg                  "$@" ;;
        text)               qywx_bot_send_text_msg                      "$@" ;;
        link)               qywx_bot_send_link_msg                      "$@" ;;
        action|actioncard)  qywx_bot_send_action_card_msg               "$@" ;;
        actioncards)        qywx_bot_send_multiple_action_card_msg      "$@" ;;
        feedcard)           qywx_bot_send_feed_card_msg                 "$@" ;;
    esac
}

qywx_bot_endpoint(){
    local O=${O:-qywx_DEFAULT} 
    local endpoint

    # set
    if [ -n "$1" ]; then 
        param_default put "qywx_$O" "endpoint" "$1"
        return 0
    fi

    # get
    endpoint="$(param_default get "qywx_$O" "endpoint")"
    if [ -z "$endpoint" ]; then
        qywx_bot_config load && endpoint="$(param_default get "qywx_$O" "endpoint")"
    fi

    [ -z "$endpoint" ] && return 1
    echo "$endpoint"
}

# qywx_bot_endpoint "$qywx_ENDPOINT"

qywx_bot_make(){
    local O="${O:-qywx_DEFAULT}"

    # local O=${1:?Provide bot name}
    # echo $O
    # echo $1

    if [ -n "$1" ]; then
        qywx_bot_endpoint "$1"
    fi
}

# qywx_bot_new(){
#     oo.create_new_function qywx.bot "$@"
# }

qywx_bot_config() {
    local O="${O:-qywx_DEFAULT}"
    local op="$1"
    shift
    local path="${1:-$HOME/.x-cmd.com/config/x-bash/app.qywx.config/$O}"
    case "$op" in
    which)
        echo "$HOME/.x-cmd.com/config/x-bash/app.qywx.config/$O"
        ;;
    save)
        mkdir -p "$(dirname "$path")"
        param_default dump "qywx_$O" >"$path"
        echo "Config $O saved in path: $path" >&2
        ;;
    load)
        param_default load "qywx_$O" "$path"
        echo "Config $O load from path: $path" >&2
        endpoint="$(param_default get "qywx_$O" "endpoint")"
        qywx_bot_endpoint "$endpoint"
        ;;
    *)
        echo "Provide config operation type which|save|load"
        ;;
    esac
}

# shellcheck disable=SC2120
qywx_bot_send_json(){
    local O=${O:-qywx_DEFAULT}
    local json="$1"
    if [ -z "$json" ]; then
        json="$(cat)"
    fi

    echo curl "$(qywx_bot_endpoint)" \
        -H 'Content-Type:application/json' \
        -d "$json"

    # qywx.debug curl "$(qywx.bot.endpoint)" \
    #     -H 'Content-Type:application/json' \
    #     -d "$json"
}

qywx_bot_send_text_msg(){
    
    param <<A
    default     qywx___$O
    --text      "Provide text" =~      *
    --atall -a  "Notify all member of the group" =FLAG
A

    # --user=el   -u  "Provide user name"         =~      [A-Za-z0-9]+
    # --access    -a  "Access Priviledge"         =       public private
    # --verbose   -v  "Display in verbose mode"   =FLAG
    # #1          =~      [A-Za-z0-9\n]+
    # ...         =~      [A-Za-z0-9\n]+
    # param '
    #     text       "Provide text" =str
    #     at=""      "The cell phone number of the person being @ (in the text content should have @ cell phone number)" =~[,] \\+?[0-9]+
    #     --atall -a "Notify all member of the group"
    # '

    qywx_bot_send_json << EOM
'{
    "msgtype": "text",
    "text": {
        "content": "$text"
    },
    "at": {
        "atMobiles": [ ${allMobiles} ],
        "isAtAll": $atall
    }
}'
EOM
}

qywx_bot_send_link_msg(){
    param <<A
    default     qywx___$O
    --title   "Provide title"     =~      *
    --text    "Provide text"      =~      *
    --picurl  "Provide picurl"    =~      *
    --msgurl  "Provide msgurl"    =~      *
A
    
    qywx_bot_send_json << EOM
'{
    "msgtype": "link",
    "link": {
        "text": "${text}",
        "title": "${title}",
        "picUrl": "${picurl}",
        "messageUrl": "${msgurl}"
    }
}'
EOM

}

qywx_bot_send_markdown_msg(){
    param <<A
    default     qywx___$O
    --title "Provide title"    =~ *
    --text  "Provide text"     =~ *
    --atall -a  "Notify all member of the group" =FLAG
A

    # TODO: Check this code

    qywx_bot_send_json << EOM
'{
    "msgtype": "markdown",
    "markdown": {
        "title": "$title",
        "text":  "$text"
    },
    "at": {
        "atMobiles": [ ${allMobiles} ],
        "isAtAll": $atall
    }
}'
EOM
}

qywx_bot_send_action_card_msg(){
    param <<A
    default     qywx___$O
    --title   "Provide title" =~      *
    --text    "Provide text"  =~      *
    --atall -a  "Notify all member of the group" =FLAG
    --orientation=1   "Buttons Placenment. 0=vertical. 1=horizontal" = 0 1
    --linktitle       "Link title" =~      *
    --linkurl         "link url"   =~      *
A
    
    local O=${O:-default}
    qywx_bot_send_json << EOM 
'{
    "msgtype": "actionCard",
    "actionCard": {
        "title": "$title",
        "text":  "$text",
        "btnOrientation": "$orientation",
        "singleTitle" :   "$linktitle",
        "singleURL" :     "$linkurl"
    },
    "at": {
        "isAtAll": $atall
    }
}'
EOM

}

qywx_bot_send_multiple_action_card_msg(){

    param <<A
    default     qywx___$O
    --title "Provide title"  =~      *
    --text  "Provide text"   =~      *
    --orientation=0 "button orientation 0 = vertical, 1=horizontal, default is 0" =int 0 1
    ... "Provide multiple action card in following format. [ <title> <action-url> ] ..." =~ *
A

    local actionTitle 
    local url
    local item 
    local all=""

    while [ $# -gt 0 ]; do
        actionTitle="$1"
        url="$2"
        item="{ \"title\": \"$actionTitle\", \"actionURL\": \"$url\" }"
        all="${all:+"$all,"}$item"
        shift 2
    done

    local allMobiles i
    for i in "${at[@]}"; do
        allMobiles+=,\"$i\"
    done
    allMobiles=${allMobiles:1}

    local IFS=','
    qywx_bot_send_json << EOM 
'{
    "msgtype": "actionCard",
    "actionCard": {
        "title": "${title:?"Please provide content"}",
        "text": "${text:?"Please provide content"}",
        "btnOrientation": "${orientation}",
        "btns": [
            $all
        ]
    },
    "at": {
        "atMobiles": [ "${allMobiles}" ]
        "isAtAll": $atall
    }
}'
EOM

}

qywx_bot_send_feed_card_msg(){

    param <<A
    default     qywx___$O
    --title "Provide title"      =~      *
    --msgurl "Provide msg url"   =~      *
    --picurl "Provide msg url"   =~      *
    ... "Provide multiple action card in following format. [ <title> <message-url> <picture-url> ] ..." =~ *
A

    qywx_bot_send_json << EOM
'{
    "msgtype": "feedCard",
    "feedCard": {
        "links": [
            ${all[*]}
        ]
    }
}'
EOM

}
